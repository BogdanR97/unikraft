LIBELFDIR = libelf
SRCS = $(wildcard $(LIBELFDIR)/*.c)
CMDS = $(patsubst $(LIBELFDIR)/%.c,$(LIBELFDIR)/%.o,$(SRCS))
INCLUDES = -I./include -Iplat/kvm/include/kvm -Inolibc/include -Ilibelf/include -I./plat/kvm/include

all: $(CMDS) link obj_copy

$(LIBELFDIR)/%.o: $(LIBELFDIR)/%.c
	gcc   -nostdinc -nostdlib -U __linux__ -U __FreeBSD__ -U __sun__ \
	$(INCLUDES) \
	-fno-stack-protector -fno-omit-frame-pointer -fno-tree-sra -Wall -Wextra \
	-D __Unikraft__ -DUK_CODENAME="Rhea" -DUK_VERSION=0.4 -DUK_FULLVERSION=0.4.0~ae054e4 \
	-fno-builtin-exit -fno-builtin-exit-group -O2 -no-pie -D__X86_64__ -m64 -mno-red-zone \
	-fno-reorder-blocks -fno-asynchronous-unwind-tables  -mtune=generic  -DCC_VERSION=8.4  \
	-fno-builtin-printf -fno-builtin-fprintf -fno-builtin-sprintf -fno-builtin-snprintf \
	-fno-builtin-vprintf -fno-builtin-vfprintf -fno-builtin-vsprintf -fno-builtin-vsnprintf \
	-fno-builtin-scanf -fno-builtin-fscanf -fno-builtin-sscanf -fno-builtin-vscanf \
	-fno-builtin-vfscanf -fno-builtin-vsscanf -g3 -D__LIBNAME__=libelf\
	-D__BASENAME__=$(subst $(LIBELFDIR)/,,$<) \
	-c $< \
	-o build/libelf/$(subst $(LIBELFDIR)/,,$@) \
	-Wp,-MD,build/libelf/.$(subst $(LIBELFDIR)/,,$@).d \

link:
	gcc -nostdinc -nostdlib -Wl,--omagic -Wl,-r -Wl,-d -Wl,--build-id=none -no-pie \
	$(patsubst $(LIBELFDIR)/%.o,build/libelf/%.o,$(CMDS)) \
	-Wl,--start-group -Wl,--end-group -o build/libelf.ld.o

obj_copy:
	objcopy --keep-global-symbols=libelf/exportsyms.uk -w -L __* build/libelf.ld.o build/libelf.o

clean:
	rm -rf build/libelf/* build/libelf/.*.o.d build/libelf.ld.o build/libelf.o
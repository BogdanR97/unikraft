ELFLOADERDIR = elfloader
SRCS = $(wildcard $(ELFLOADERDIR)/*.c)
CMDS = $(patsubst $(ELFLOADERDIR)/%.c,$(ELFLOADERDIR)/%.o,$(SRCS))
INCLUDES = -I./include -Iplat/kvm/include/kvm -Inolibc/include -Ilibelf/include -I./plat/kvm/include

all: $(CMDS) link obj_copy

$(ELFLOADERDIR)/%.o: $(ELFLOADERDIR)/%.c
	gcc   -nostdinc -nostdlib -U __linux__ -U __FreeBSD__ -U __sun__ \
	$(INCLUDES) \
	-fno-stack-protector -fno-omit-frame-pointer -fno-tree-sra -Wall -Wextra \
	-D __Unikraft__ -DUK_CODENAME="Rhea" -DUK_VERSION=0.4 -DUK_FULLVERSION=0.4.0~ae054e4 \
	-fno-builtin-exit -fno-builtin-exit-group -O2 -no-pie -D__X86_64__ -m64 -mno-red-zone \
	-fno-reorder-blocks -fno-asynchronous-unwind-tables  -mtune=generic  -DCC_VERSION=8.4  \
	-fno-builtin-printf -fno-builtin-fprintf -fno-builtin-sprintf -fno-builtin-snprintf \
	-fno-builtin-vprintf -fno-builtin-vfprintf -fno-builtin-vsprintf -fno-builtin-vsnprintf \
	-fno-builtin-scanf -fno-builtin-fscanf -fno-builtin-sscanf -fno-builtin-vscanf \
	-fno-builtin-vfscanf -fno-builtin-vsscanf -g3 -D__LIBNAME__=elfloader\
	-D__BASENAME__=$(subst $(ELFLOADERDIR)/,,$<) \
	-c $< \
	-o build/elfloader/$(subst $(ELFLOADERDIR)/,,$@) \
	-Wp,-MD,build/elfloader/.$(subst $(ELFLOADERDIR)/,,$@).d \

link:
	gcc -nostdinc -nostdlib -Wl,--omagic -Wl,-r -Wl,-d -Wl,--build-id=none -no-pie \
	$(patsubst $(ELFLOADERDIR)/%.o,build/elfloader/%.o,$(CMDS)) \
	-Wl,--start-group -Wl,--end-group -o build/elfloader.ld.o

obj_copy:
	objcopy --keep-global-symbols=elfloader/exportsyms.uk -w -L __* build/elfloader.ld.o build/elfloader.o

clean:
	rm -rf build/elfloader/* build/elfloader/.*.o.d build/elfloader.ld.o build/elfloader.o